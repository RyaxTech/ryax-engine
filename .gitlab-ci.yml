variables:
  # Default values to override if needed
  NIX_OPTS: --extra-experimental-features nix-command --extra-experimental-features flakes --log-format raw
  # WARNING This assume that the pytest-cov package is available. If not installed you'll have this error:
  # pytest: error: unrecognized arguments: --cov ...
  TEST_EXTRA_ARGS: --cov ./ryax --cov-report xml:coverage.xml --cov-report term --cov-config=.coveragerc --cov-branch --junitxml=./report.xml
  LINT_CMD: ./lint.sh
  CHARTS: ./chart
  FILES_TO_PREPROCESS: "pyproject.toml chart/Chart.yaml chart/values.yaml"

  SERVICE_VERSION: $CI_COMMIT_SHORT_SHA
  APP_VERSION: v$SERVICE_VERSION
  CHART_VERSION: 0.0.0-v$SERVICE_VERSION

  # To be set by services
  RYAX_TOOL: ""
  RYAX_ADM_VERSION: ""
  # To be set in the CI variables
  #CACHIX_AUTH_TOKEN=""
  RYAX_VALUES: ryax_values.yaml
  RYAX_PROJECTS: ryax_projects.json
  RYAX_CLUSTER_NAME: prerelease
  GITLAB_ID: cicd-ryax # id of the bot. It matters for the API scripts
  GITLAB_TOKEN: $RYAX_CI_ACCESS_TOKEN
  KUBECONFIG: /data/kubeconfig.yaml
  RYAX_ADM_IMAGE: ryax-adm:staging

stages:
  - setup
  - init
  - deploy
  - release
  - release_artifacts
  - release_saas
  - check_helm_charts
  - push_helm_charts

# Conventions
#
# - ryax_config.yaml is the current configuration of the pre-release cluster
# - ryax_config_$CI_COMMIT_TAG is the configuration generated by ryax-adm release

# WARNING: sed is required everywhere this is in use
.set_versions: &set_versions
  # Replace versions placeholders
  - echo "Updating files with version $SERVICE_VERSION"
  - echo APP_VERSION=$APP_VERSION
  - echo CHART_VERSION=$CHART_VERSION
  - |
    for f in $FILES_TO_PREPROCESS; do
      [ ! -f $f ] && echo "$f is not a file." && exit 1
      echo "Processing file $f"
      sed -i "s/SERVICE-VERSION/$APP_VERSION/" $f
      sed -i "s/^version: .*/version: $CHART_VERSION/" $f
    done

workflow:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^([0-9]+.){2}[0-9]+([-+][a-zA-Z0-9-]*)?$/'

.k8s_login: &k8s_login
  - RYAX_CLUSTER_ID=$(scw k8s cluster list name=$RYAX_CLUSTER_NAME -o json | jq '.[].id' -r)
  - scw k8s kubeconfig get $RYAX_CLUSTER_ID > $KUBECONFIG

get_staging_commit_sha:
  stage: setup
  image: ryaxtech/ryax-ci:23.11-2
  tags:
    - docker
  artifacts:
    paths:
      - ./ryax_projects.json
  before_script:
    - ""
  script:
    - echo Retrieving staging commit shas
    - ./get_project_versions.sh
    - echo $RYAX_PROJECTS was updated

get_cluster_values:
  stage: setup
  tags:
    - docker
    - kubernetes
  image:
    name: $DEV_REGISTRY_PATH/$RYAX_ADM_IMAGE
    entrypoint: [""]
  artifacts:
    paths:
      - ./ryax_values.yaml
  script:
    - *k8s_login
    - >
      ryax-adm init
      --values $RYAX_VALUES
      --from-cluster
      --set appRegistry.url="$DEV_REGISTRY_PATH"
      --set appRegistry.user="$REGISTRY_USER"
      --set appRegistry.pass="$REGISTRY_PASS"
      --set chartRegistry.url="$DEV_CHART_REPO"
      --set chartRegistry.user="$REGISTRY_USER"
      --set chartRegistry.pass="$REGISTRY_PASS"

set_versions:
  stage: init
  tags:
    - docker
  image: ryaxtech/ryax-ci:23.11-2
  artifacts:
    name: $RYAX_CLUSTER_NAME-values-$CI_COMMIT_TAG
    paths:
      - ./ryax_values.yaml
  before_script:
    - ""
  script:
    - echo Updating service versions
      # Everything except charts contained in common-helm-charts
    - |
      for service in $(jq -c '.[]' $RYAX_PROJECTS); do
        name=$(echo $service | jq -r '.name')
        commit_sha=$(echo $service | jq -r '.staging_commit_sha')
        echo Updating $name version to $commit_sha
        cat $RYAX_VALUES | yq -r -y ". * {\"$name\": {\"chartVersion\" : \"0.0.0-v$commit_sha\"}}" | sponge $RYAX_VALUES
          # cat $RYAX_VALUES | yq -r -y ". * {\"$name\": {\"appVersion\" : \"v$commit_sha\"}}" | sponge $RYAX_VALUES
      done
      # Charts contained within common-helm-charts
    - common_resources_sha="$(jq -r '.[] | select(.name=="commonResources") | .staging_commit_sha' $RYAX_PROJECTS)"
    - |
      for service in datastore registry; do
        echo Updating $service version to $common_resources_sha
        cat $RYAX_VALUES | yq -r -y ". * {\"$service\": {\"chartVersion\" : \"0.0.0-v$common_resources_sha\"}}" | sponge $RYAX_VALUES
      done
    - echo "Resulting $RYAX_VALUES:"
    - cat $RYAX_VALUES

upgrade_pre-release:
  stage: deploy
  tags:
    - docker
  environment:
    name: $RYAX_CLUSTER_NAME
    url: https://$RYAX_CLUSTER_NAME.ryax.io
  image:
    name: $DEV_REGISTRY_PATH/$RYAX_ADM_IMAGE
    entrypoint: [""]
  script:
    - *k8s_login
    - >
      ryax-adm apply
      --values $RYAX_VALUES

release_repositories:
  stage: release
  when: manual
  allow_failure: false
  image: ryaxtech/ryax-ci:23.11-2
  tags:
    - docker
  before_script:
    - ""
  script:
    # Tags all services with this pipeline tag
    - ./tag-repos.sh

#  variables:
#    CHARTS "" # paths to the charts to push
lint_helm_charts:
  stage: check_helm_charts
  when: manual
  allow_failure: false
  tags:
    - docker
  image:
    name: alpine/helm:3.16.1
    entrypoint: [""]
  script:
    - |
      for chart in $CHARTS; do
        echo "Linting chart $chart"
        helm dep update $chart
        helm lint $chart
      done

push_helm_charts:
  stage: push_helm_charts
  when: manual
  allow_failure: false
  tags:
    - docker
  image:
    name: alpine/helm:3.16.1
    entrypoint: [""]
  variables:
    CHART_REPO_PATH: $DEV_CHART_REPO
    CHART_REPO_USER: $REGISTRY_USER
    CHART_REPO_PASS: $REGISTRY_PASS
  before_script:
    - *set_versions
  script:
    - helm registry login $CHART_REPO_PATH --username $CHART_REPO_USER --password $CHART_REPO_PASS
    - "echo Charts to be pushed: $CHARTS"
    - |
      for chart in $CHARTS; do
        cat $chart/Chart.yaml
        helm dep update $chart # Dependencies are included in the package
        CHART_ARCHIVE=$(helm package $chart | cut -f2 -d':')
        CHART_REPO_URL=oci://$CHART_REPO_PATH
        echo "Pushing Chart $CHART_ARCHIVE to $CHART_REPO_URL"
        helm push $CHART_ARCHIVE $CHART_REPO_URL
        echo "Chart $CHART_ARCHIVE successfully pushed to $CHART_REPO_URL"
      done

